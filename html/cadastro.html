<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pacientes - OdontoClinic</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --cor-fundo-tela: #c79646;
            --cor-sidebar: #a67c42;
            --cor-texto-marrom: #5e4b35;
        }
        body { background-color: var(--cor-fundo-tela); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow-x: hidden; }

        /* Sidebar */
        .sidebar { background-color: var(--cor-sidebar); min-height: 100vh; color: white; padding: 20px; box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
        .nav-link { color: rgba(255,255,255, 0.8); font-size: 1.1rem; margin-bottom: 15px; border-radius: 10px; padding: 12px 20px; transition: all 0.3s; }
        .nav-link:hover { background-color: rgba(255,255,255, 0.2); color: white; transform: translateX(5px); }
        .nav-link.active { background-color: rgba(255,255,255, 0.25); color: white; font-weight: bold; }
        .nav-link i { margin-right: 10px; width: 25px; text-align: center; }

        /* Glassmorphism */
        .glass-container {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            min-height: 70vh;
        }

        .glass-item {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border-left: 6px solid var(--cor-sidebar);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .glass-item:hover {
            background: #fff;
            transform: translateX(10px) scale(1.01);
            box-shadow: 0 10px 20px rgba(166, 124, 66, 0.2);
        }

        .search-glass {
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255,255,255,0.5);
            color: #5e4b35;
            padding-left: 50px;
        }
        
        .search-icon {
            position: absolute; left: 20px; top: 50%; transform: translateY(-50%);
            color: var(--cor-sidebar); opacity: 0.7; z-index: 10;
        }

        .info-label { font-size: 0.7rem; text-transform: uppercase; color: #a67c42; font-weight: 800; letter-spacing: 0.5px; }
        .info-text { font-size: 1rem; color: #444; font-weight: 600; }
        
        .badge-menor {
            background-color: #ffefc2; color: #856404;
            font-size: 0.7rem; padding: 2px 6px; border-radius: 4px;
            border: 1px solid #ffeeba; margin-left: 5px;
        }
    </style>
</head>
<body>

    <div class="container-fluid">
        <div class="row">
            <nav class="col-md-3 col-lg-2 sidebar d-none d-md-block">
                <div class="text-center mt-4 mb-5">
                    <i class="fa-solid fa-tooth fa-3x mb-2"></i>
                    <h5 class="fw-bold">Emilly Ebersol</h5>
                    <small>Cirurgiã-Dentista</small>
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item"><a class="nav-link" href="dashboard.html"><i class="fa-solid fa-house"></i> Início</a></li>
                    <li class="nav-item"><a class="nav-link" href="agenda.html"><i class="fa-solid fa-calendar-days"></i> Agenda</a></li>
                    <li class="nav-item"><a class="nav-link active" href="#"><i class="fa-solid fa-users"></i> Pacientes</a></li>
                    <li class="nav-item"><a class="nav-link" href="registros.html"><i class="fa-solid fa-clipboard-list"></i> Registros Diários</a></li>
                    <li class="nav-item"><a class="nav-link" href="notas.html"><i class="fa-solid fa-file-invoice"></i> Controle Recibos</a></li>
                    <li class="nav-item"><a class="nav-link" href="precos.html"><i class="fa-solid fa-file-invoice-dollar"></i> Tabela de Preço</a></li>
                    <li class="nav-item"><a class="nav-link" href="relatorios.html"><i class="fa-solid fa-chart-pie"></i> Relatórios</a></li>
                    <li class="nav-item mt-3"><a class="nav-link text-warning" href="index.html"><i class="fa-solid fa-right-from-bracket"></i> Sair</a></li>
                </ul>
            </nav>

            <main class="col-md-9 col-lg-10 p-4">
                
                <div class="d-flex justify-content-between align-items-center mb-4 text-white">
                    <div>
                        <h2 class="fw-bold m-0"><i class="fa-solid fa-users me-2 opacity-75"></i>Pacientes</h2>
                        <small class="opacity-75">Gerencie seus cadastros</small>
                    </div>
                    <button class="btn btn-light text-primary fw-bold shadow" onclick="abrirModalNovo()">
                        <i class="fa-solid fa-user-plus me-2"></i> Novo Paciente
                    </button>
                </div>

                <div class="glass-container position-relative">
                    <div class="mb-4 position-relative">
                        <i class="fa-solid fa-magnifying-glass search-icon"></i>
                        <input type="text" id="inputBusca" class="form-control form-control-lg search-glass" placeholder="Buscar por nome ou CPF..." onkeyup="filtrarPacientes()">
                    </div>

                    <div id="lista-pacientes">
                        <div class="text-center text-white py-5">
                            <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
                            <p class="mt-2">Carregando lista...</p>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <div class="modal fade" id="modalNovoPaciente" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold" id="tituloModal">Cadastrar Paciente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formPaciente">
                        <input type="hidden" id="nomeOriginal">

                        <div class="mb-3">
                            <label class="fw-bold small">Nome Completo</label>
                            <input type="text" id="cadNome" class="form-control" required onblur="capitalizarNome(this)">
                        </div>

                        <div class="row">
                            <div class="col-7 mb-3">
                                <label class="fw-bold small">Data de Nascimento</label>
                                <input type="date" id="cadNascimento" class="form-control" onchange="verificarIdade()" required>
                            </div>
                            <div class="col-5 mb-3 d-flex align-items-end">
                                <span id="labelIdade" class="badge bg-secondary p-2 w-100">--- anos</span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="fw-bold small">CPF Paciente</label>
                                <input type="text" id="cadCPF" class="form-control" placeholder="000.000.000-00" maxlength="14" oninput="aplicarMascaraCPF(this)">
                            </div>
                            <div class="col-6 mb-3" id="boxResponsavel" style="display: none;">
                                <label class="fw-bold small text-danger">CPF Responsável *</label>
                                <input type="text" id="cadCPFResp" class="form-control border-danger" placeholder="Obrigatório" maxlength="14" oninput="aplicarMascaraCPF(this)">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="fw-bold small">Telefone</label>
                            <input type="text" id="cadTel" class="form-control" placeholder="(00) 00000-0000" maxlength="15" oninput="mascaraTelefone(this)">
                        </div>
                        <div class="mb-3">
                            <label class="fw-bold small">Endereço Completo</label>
                            <input type="text" id="cadEndereco" class="form-control" placeholder="Rua, Número, Bairro...">
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100" style="background-color: var(--cor-sidebar);">Salvar Dados</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalHistorico" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header text-white" style="background-color: var(--cor-sidebar);">
                    <h5 class="modal-title fw-bold"><i class="fa-solid fa-file-medical me-2"></i>Ficha Clínica</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-4 bg-light p-3 rounded mx-0">
                        <div class="col-md-8">
                            <small class="text-muted text-uppercase fw-bold">Paciente</small>
                            <h3 class="fw-bold text-dark m-0" id="histNome">---</h3>
                            <div id="histDadosExtras" class="small text-muted mt-1"></div>
                        </div>
                        <div class="col-md-4 text-end">
                            <small class="text-muted text-uppercase fw-bold">Contato</small>
                            <div class="fs-5" id="histContato">---</div>
                        </div>
                    </div>
                    <h5 class="border-bottom pb-2 mb-3 text-muted">Histórico</h5>
                    <div id="lista-historico" class="list-group list-group-flush"></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let pacientesCache = [];
        let modalHistoricoInstance;
        let modalCadastroInstance;

        window.onload = function() {
            carregarPacientes();
            modalHistoricoInstance = new bootstrap.Modal(document.getElementById('modalHistorico'));
            modalCadastroInstance = new bootstrap.Modal(document.getElementById('modalNovoPaciente'));
        };

        // --- MÁSCARA TELEFONE ---
        function mascaraTelefone(input) {
            let v = input.value.replace(/\D/g, ""); // Remove tudo que não é dígito
            v = v.replace(/^(\d{2})(\d)/g, "($1) $2"); // Coloca parênteses no DDD
            v = v.replace(/(\d)(\d{4})$/, "$1-$2"); // Coloca o hífen antes dos últimos 4 dígitos
            input.value = v;
        }

        // --- CAPITALIZAR NOME ---
        function capitalizarNome(input) {
            let palavras = input.value.toLowerCase().split(' ');
            for (let i = 0; i < palavras.length; i++) {
                // Não capitaliza 'de', 'da', 'do', 'dos', 'das' se não for a primeira palavra
                if (['de', 'da', 'do', 'dos', 'das', 'e'].includes(palavras[i]) && i !== 0) continue;
                palavras[i] = palavras[i].charAt(0).toUpperCase() + palavras[i].slice(1);
            }
            input.value = palavras.join(' ');
        }

        // --- MÁSCARA DE CPF ---
        function aplicarMascaraCPF(input) {
            let v = input.value.replace(/\D/g, "");
            v = v.replace(/(\d{3})(\d)/, "$1.$2");
            v = v.replace(/(\d{3})(\d)/, "$1.$2");
            v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
            input.value = v;
        }

        function verificarIdade() {
            const dataNasc = document.getElementById('cadNascimento').value;
            if (!dataNasc) return;

            const hoje = new Date();
            const nascimento = new Date(dataNasc);
            let idade = hoje.getFullYear() - nascimento.getFullYear();
            const m = hoje.getMonth() - nascimento.getMonth();
            if (m < 0 || (m === 0 && hoje.getDate() < nascimento.getDate())) idade--;

            const badge = document.getElementById('labelIdade');
            badge.innerText = `${idade} anos`;
            const boxResp = document.getElementById('boxResponsavel');
            const inputResp = document.getElementById('cadCPFResp');
            
            if (idade < 18) {
                badge.className = "badge bg-warning text-dark p-2 w-100";
                boxResp.style.display = "block";
                inputResp.required = true;
            } else {
                badge.className = "badge bg-success p-2 w-100";
                boxResp.style.display = "none";
                inputResp.required = false;
            }
        }

        async function carregarPacientes() {
            try {
                const res = await fetch('/api/pacientes');
                if (!res.ok) throw new Error("Erro API");
                pacientesCache = await res.json();
                renderizarLista(pacientesCache);
            } catch (erro) {
                document.getElementById('lista-pacientes').innerHTML = '<p class="text-white text-center">Erro ao carregar lista.</p>';
            }
        }

        function renderizarLista(lista) {
            const container = document.getElementById('lista-pacientes');
            container.innerHTML = '';

            if (lista.length === 0) {
                container.innerHTML = `<div class="text-center text-white mt-5 opacity-75"><h4>Nenhum paciente encontrado.</h4></div>`;
                return;
            }

            lista.forEach(p => {
                let badgeMenor = '';
                if (p.dataNascimento) {
                    const nascimento = new Date(p.dataNascimento);
                    const hoje = new Date();
                    let idade = hoje.getFullYear() - nascimento.getFullYear();
                    const m = hoje.getMonth() - nascimento.getMonth();
                    if (m < 0 || (m === 0 && hoje.getDate() < nascimento.getDate())) idade--;
                    if(idade < 18) badgeMenor = '<span class="badge-menor">Menor</span>';
                }

                const pString = JSON.stringify(p).replace(/"/g, '&quot;');

                const card = `
                <div class="glass-item" onclick="abrirProntuario('${p.nome}', '${p.telefone || ''}', '${p.cpf || ''}', '${p.cpfResponsavel || ''}')">
                    <div class="row w-100 align-items-center m-0">
                        <div class="col-md-3">
                            <div class="info-label">Nome</div>
                            <div class="info-text text-truncate" title="${p.nome}">${p.nome} ${badgeMenor}</div>
                        </div>
                        <div class="col-md-2">
                            <div class="info-label">CPF</div>
                            <div class="info-text small">${p.cpf || '-'}</div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-label">Endereço</div>
                            <div class="info-text text-truncate small" title="${p.endereco || ''}">
                                <i class="fa-solid fa-location-dot text-muted me-1"></i>${p.endereco || '-'}
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="info-label">Contato</div>
                            <div class="info-text small"><i class="fa-brands fa-whatsapp text-success me-1"></i>${p.telefone || '-'}</div>
                        </div>
                        
                        <div class="col-md-2 text-end">
                            <button class="btn btn-sm btn-outline-warning me-1" onclick="event.stopPropagation(); prepararEdicao(${pString})" title="Editar">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deletarPaciente('${p.nome}')" title="Excluir">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>`;
                container.innerHTML += card;
            });
        }

        function abrirModalNovo() {
            document.getElementById('formPaciente').reset();
            document.getElementById('nomeOriginal').value = ''; 
            document.getElementById('tituloModal').innerText = "Cadastrar Paciente";
            document.getElementById('boxResponsavel').style.display = 'none';
            document.getElementById('labelIdade').className = 'badge bg-secondary p-2 w-100';
            document.getElementById('labelIdade').innerText = '--- anos';
            
            modalCadastroInstance.show();
        }

        function prepararEdicao(p) {
            document.getElementById('tituloModal').innerText = "Editar Paciente";
            document.getElementById('nomeOriginal').value = p.nome;

            document.getElementById('cadNome').value = p.nome;
            document.getElementById('cadNascimento').value = p.dataNascimento || '';
            document.getElementById('cadCPF').value = p.cpf || '';
            document.getElementById('cadCPFResp').value = p.cpfResponsavel || '';
            document.getElementById('cadTel').value = p.telefone || '';
            document.getElementById('cadEndereco').value = p.endereco || '';

            verificarIdade();

            modalCadastroInstance.show();
        }

        document.getElementById('formPaciente').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const nomeOriginal = document.getElementById('nomeOriginal').value;
            
            // Força a capitalização uma última vez antes de salvar, caso o usuário tenha colado o texto
            const inputNome = document.getElementById('cadNome');
            capitalizarNome(inputNome);

            const dados = {
                nomeOriginal: nomeOriginal,
                nome: inputNome.value,
                dataNascimento: document.getElementById('cadNascimento').value,
                cpf: document.getElementById('cadCPF').value,
                cpfResponsavel: document.getElementById('cadCPFResp').value,
                telefone: document.getElementById('cadTel').value,
                endereco: document.getElementById('cadEndereco').value 
            };
            
            const metodo = nomeOriginal ? 'PUT' : 'POST';
            
            modalCadastroInstance.hide();
            
            try {
                const res = await fetch('/api/pacientes', {
                    method: metodo, 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify(dados)
                });
                const resposta = await res.json();
                
                if (res.ok) {
                    alert(nomeOriginal ? "✅ Cadastro atualizado!" : "✅ Paciente cadastrado!");
                    carregarPacientes();
                } else { 
                    alert("⚠️ " + (resposta.error || "Erro ao salvar.")); 
                }
            } catch (erro) { alert("Erro de conexão."); }
        });

        async function deletarPaciente(nome) {
            if (!confirm(`Tem certeza que deseja EXCLUIR "${nome}"?`)) return;
            try {
                await fetch('/api/pacientes', {
                    method: 'DELETE', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ nome: nome })
                });
                carregarPacientes();
            } catch (erro) { alert("Erro de conexão."); }
        }

        async function abrirProntuario(nome, telefone, cpf, cpfResp) {
            document.getElementById('histNome').innerText = nome;
            document.getElementById('histContato').innerText = telefone || '-';
            let dadosExtras = `CPF: ${cpf || 'Não inf.'}`;
            if(cpfResp) dadosExtras += ` | <span class="text-danger fw-bold">Responsável: ${cpfResp}</span>`;
            document.getElementById('histDadosExtras').innerHTML = dadosExtras;

            const container = document.getElementById('lista-historico');
            container.innerHTML = '<div class="text-center p-3"><i class="fa-solid fa-spinner fa-spin"></i> Buscando histórico...</div>';
            modalHistoricoInstance.show();
            try {
                const res = await fetch('/api/agenda');
                const agenda = await res.json();
                const historico = agenda.filter(i => i.paciente.toLowerCase().trim() === nome.toLowerCase().trim());
                container.innerHTML = '';
                if (historico.length === 0) {
                    container.innerHTML = '<div class="alert alert-warning text-center">Nenhum atendimento encontrado.</div>';
                    return;
                }
                historico.sort((a,b) => (a.data > b.data ? -1 : 1)); 
                historico.forEach(item => {
                    const [ano, mes, dia] = item.data.split('-');
                    container.innerHTML += `
                        <div class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1 fw-bold text-primary">${item.procedimento}</h5>
                                <small class="text-muted"><i class="fa-regular fa-calendar me-1"></i>${dia}/${mes}/${ano} às ${item.hora}</small>
                            </div>
                        </div>`;
                });
            } catch (erro) { container.innerHTML = '<div class="alert alert-danger">Erro ao carregar histórico.</div>'; }
        }

        function filtrarPacientes() {
            const termo = document.getElementById('inputBusca').value.toLowerCase();
            renderizarLista(pacientesCache.filter(p => p.nome.toLowerCase().includes(termo)));
        }
    </script>
</body>
</html>